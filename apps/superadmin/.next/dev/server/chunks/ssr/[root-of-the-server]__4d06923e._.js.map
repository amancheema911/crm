{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/client.ts"],"sourcesContent":["import { createClient, type SupabaseClient } from \"@supabase/supabase-js\";\r\nimport type { User as SupabaseUser } from \"@supabase/supabase-js\";\r\nimport type { User, AppRole } from \"./types\";\r\n\r\nconst DEFAULT_ROLE: AppRole = \"customer\";\r\n\r\n/**\r\n * Create a Supabase client for browser use.\r\n * Call from each app with env: createSupabaseClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!)\r\n */\r\nexport function createSupabaseClient(\r\n  url: string,\r\n  anonKey: string\r\n): SupabaseClient {\r\n  return createClient(url, anonKey);\r\n}\r\n\r\n/**\r\n * Map Supabase user + user_metadata to our User type.\r\n */\r\nexport function mapSupabaseUserToUser(supabaseUser: SupabaseUser | null): User | null {\r\n  if (!supabaseUser) return null;\r\n\r\n  const meta = (supabaseUser.user_metadata ?? {}) as {\r\n    role?: AppRole;\r\n    workspace_id?: number;\r\n    full_name?: string;\r\n    name?: string;\r\n  };\r\n  const role = meta.role ?? DEFAULT_ROLE;\r\n  const workspace_id =\r\n    typeof meta.workspace_id === \"number\" ? meta.workspace_id : null;\r\n  const name =\r\n    meta.full_name ?? meta.name ?? supabaseUser.email?.split(\"@\")[0] ?? null;\r\n\r\n  return {\r\n    id: supabaseUser.id,\r\n    email: supabaseUser.email ?? \"\",\r\n    name,\r\n    role,\r\n    workspace_id,\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAIA,MAAM,eAAwB;AAMvB,SAAS,qBACd,GAAW,EACX,OAAe;IAEf,OAAO,IAAA,8LAAY,EAAC,KAAK;AAC3B;AAKO,SAAS,sBAAsB,YAAiC;IACrE,IAAI,CAAC,cAAc,OAAO;IAE1B,MAAM,OAAQ,aAAa,aAAa,IAAI,CAAC;IAM7C,MAAM,OAAO,KAAK,IAAI,IAAI;IAC1B,MAAM,eACJ,OAAO,KAAK,YAAY,KAAK,WAAW,KAAK,YAAY,GAAG;IAC9D,MAAM,OACJ,KAAK,SAAS,IAAI,KAAK,IAAI,IAAI,aAAa,KAAK,EAAE,MAAM,IAAI,CAAC,EAAE,IAAI;IAEtE,OAAO;QACL,IAAI,aAAa,EAAE;QACnB,OAAO,aAAa,KAAK,IAAI;QAC7B;QACA;QACA;IACF;AACF"}},
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/user.ts"],"sourcesContent":["import type { SupabaseClient } from \"@supabase/supabase-js\";\r\nimport type { User, AppRole } from \"./types\";\r\nimport { mapSupabaseUserToUser } from \"./client\";\r\n\r\n/**\r\n * Get the current authenticated user from Supabase.\r\n * Returns our User type with role and workspace_id from user_metadata.\r\n */\r\nexport async function getCurrentUser(\r\n  client: SupabaseClient\r\n): Promise<User | null> {\r\n  const {\r\n    data: { user: supabaseUser },\r\n    error,\r\n  } = await client.auth.getUser();\r\n  if (error || !supabaseUser) return null;\r\n  return mapSupabaseUserToUser(supabaseUser);\r\n}\r\n\r\n/**\r\n * Get the user's role from our User (from auth.users.user_metadata.role).\r\n */\r\nexport function getRole(user: User): AppRole {\r\n  return user.role;\r\n}\r\n\r\n/**\r\n * Get the user's workspace_id from our User (from auth.users.user_metadata.workspace_id).\r\n */\r\nexport function getWorkspaceId(user: User): number | null {\r\n  return user.workspace_id;\r\n}\r\n\r\n/**\r\n * Check if the user's role is in the allowed list (for route guards).\r\n */\r\nexport function isRoleAllowed(\r\n  role: AppRole,\r\n  allowedRoles: readonly AppRole[]\r\n): boolean {\r\n  return allowedRoles.includes(role);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAEA;;AAMO,eAAe,eACpB,MAAsB;IAEtB,MAAM,EACJ,MAAM,EAAE,MAAM,YAAY,EAAE,EAC5B,KAAK,EACN,GAAG,MAAM,OAAO,IAAI,CAAC,OAAO;IAC7B,IAAI,SAAS,CAAC,cAAc,OAAO;IACnC,OAAO,IAAA,gKAAqB,EAAC;AAC/B;AAKO,SAAS,QAAQ,IAAU;IAChC,OAAO,KAAK,IAAI;AAClB;AAKO,SAAS,eAAe,IAAU;IACvC,OAAO,KAAK,YAAY;AAC1B;AAKO,SAAS,cACd,IAAa,EACb,YAAgC;IAEhC,OAAO,aAAa,QAAQ,CAAC;AAC/B"}},
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/access.ts"],"sourcesContent":["import type { AppRole } from \"./types\";\r\nimport { isRoleAllowed } from \"./user\";\r\n\r\n/**\r\n * Allowed roles per app – single source of truth for final access validation.\r\n * - Superadmin cannot access workspace app.\r\n * - Workspace admin cannot access superadmin app.\r\n * - Customer can access workspace app only.\r\n * - Invalid users are redirected to login (enforced by proxy + login page).\r\n */\r\nexport const SUPERADMIN_APP_ROLES: readonly AppRole[] = [\"superadmin\"];\r\nexport const WORKSPACE_APP_ROLES: readonly AppRole[] = [\r\n  \"superadmin\",\r\n  \"workspace_admin\",\r\n  \"customer\",\r\n];\r\n\r\nexport type AppName = \"superadmin\" | \"workspace\";\r\n\r\nconst APP_ROLES: Record<AppName, readonly AppRole[]> = {\r\n  superadmin: SUPERADMIN_APP_ROLES,\r\n  workspace: WORKSPACE_APP_ROLES,\r\n};\r\n\r\n/**\r\n * Final access validation: can this role access this app?\r\n * Use in proxy (route guard) and login (after sign-in).\r\n */\r\nexport function canAccessApp(role: AppRole, app: AppName): boolean {\r\n  return isRoleAllowed(role, APP_ROLES[app]);\r\n}\r\n\r\n/**\r\n * Get allowed roles for an app (for error messages / UI).\r\n */\r\nexport function getAllowedRolesForApp(app: AppName): readonly AppRole[] {\r\n  return APP_ROLES[app];\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AACA;;AASO,MAAM,uBAA2C;IAAC;CAAa;AAC/D,MAAM,sBAA0C;IACrD;IACA;IACA;CACD;AAID,MAAM,YAAiD;IACrD,YAAY;IACZ,WAAW;AACb;AAMO,SAAS,aAAa,IAAa,EAAE,GAAY;IACtD,OAAO,IAAA,sJAAa,EAAC,MAAM,SAAS,CAAC,IAAI;AAC3C;AAKO,SAAS,sBAAsB,GAAY;IAChD,OAAO,SAAS,CAAC,IAAI;AACvB"}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/session.ts"],"sourcesContent":["import type { SupabaseClient } from \"@supabase/supabase-js\";\r\nimport type { Session } from \"./types\";\r\nimport { getCurrentUser } from \"./user\";\r\n\r\n/**\r\n * Get the current session (user + expiry) from Supabase.\r\n * Use getCurrentUser(client) for just the user.\r\n */\r\nexport async function getSession(\r\n  client: SupabaseClient\r\n): Promise<Session | null> {\r\n  const user = await getCurrentUser(client);\r\n  if (!user) return null;\r\n\r\n  const {\r\n    data: { session: supabaseSession },\r\n  } = await client.auth.getSession();\r\n  const expiresAt = supabaseSession?.expires_at\r\n    ? supabaseSession.expires_at * 1000\r\n    : 0;\r\n\r\n  return {\r\n    user,\r\n    expiresAt,\r\n  };\r\n}\r\n\r\n/**\r\n * Sign out the current user via Supabase.\r\n */\r\nexport async function signOut(client: SupabaseClient): Promise<void> {\r\n  await client.auth.signOut();\r\n}\r\n"],"names":[],"mappings":";;;;;;AAEA;;AAMO,eAAe,WACpB,MAAsB;IAEtB,MAAM,OAAO,MAAM,IAAA,uJAAc,EAAC;IAClC,IAAI,CAAC,MAAM,OAAO;IAElB,MAAM,EACJ,MAAM,EAAE,SAAS,eAAe,EAAE,EACnC,GAAG,MAAM,OAAO,IAAI,CAAC,UAAU;IAChC,MAAM,YAAY,iBAAiB,aAC/B,gBAAgB,UAAU,GAAG,OAC7B;IAEJ,OAAO;QACL;QACA;IACF;AACF;AAKO,eAAe,QAAQ,MAAsB;IAClD,MAAM,OAAO,IAAI,CAAC,OAAO;AAC3B"}},
    {"offset": {"line": 123, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/logout.ts"],"sourcesContent":["import type { SupabaseClient } from \"@supabase/supabase-js\";\r\n\r\n/** Keys that may hold auth/session data in storage (clear on logout). */\r\nconst AUTH_STORAGE_KEYS = [\r\n  \"sb-\",\r\n  // Supabase uses sb-<project-ref>-auth-token; prefix covers all\r\n] as const;\r\n\r\n/**\r\n * Clear any cached auth-related data from localStorage/sessionStorage.\r\n * Supabase signOut() clears its own keys; this clears any app-specific or residual keys.\r\n */\r\nfunction clearAuthStorage(): void {\r\n  if (typeof window === \"undefined\") return;\r\n  try {\r\n    const keysToRemove: string[] = [];\r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (key && AUTH_STORAGE_KEYS.some((prefix) => key.startsWith(prefix))) {\r\n        keysToRemove.push(key);\r\n      }\r\n    }\r\n    keysToRemove.forEach((key) => localStorage.removeItem(key));\r\n    const sessionKeysToRemove: string[] = [];\r\n    for (let i = 0; i < sessionStorage.length; i++) {\r\n      const key = sessionStorage.key(i);\r\n      if (key && AUTH_STORAGE_KEYS.some((prefix) => key.startsWith(prefix))) {\r\n        sessionKeysToRemove.push(key);\r\n      }\r\n    }\r\n    sessionKeysToRemove.forEach((key) => sessionStorage.removeItem(key));\r\n  } catch {\r\n    // Ignore storage errors (e.g. private mode)\r\n  }\r\n}\r\n\r\n/**\r\n * Shared logout handler: sign out from Supabase and clear local auth/cached data.\r\n * Use this in both Superadmin and Workspace apps. After calling, clear React auth state\r\n * (e.g. AuthContext setUser(null)) and redirect to the app's login page.\r\n */\r\nexport async function performLogout(client: SupabaseClient | null): Promise<void> {\r\n  if (client) {\r\n    await client.auth.signOut();\r\n  }\r\n  clearAuthStorage();\r\n}\r\n"],"names":[],"mappings":";;;;AAEA,uEAAuE,GACvE,MAAM,oBAAoB;IACxB;CAED;AAED;;;CAGC,GACD,SAAS;IACP,wCAAmC;;;AAqBrC;AAOO,eAAe,cAAc,MAA6B;IAC/D,IAAI,QAAQ;QACV,MAAM,OAAO,IAAI,CAAC,OAAO;IAC3B;IACA;AACF"}},
    {"offset": {"line": 148, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/AuthContext.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const AuthProvider = registerClientReference(\n    function() { throw new Error(\"Attempted to call AuthProvider() from the server but AuthProvider is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/shared/src/auth/AuthContext.tsx <module evaluation>\",\n    \"AuthProvider\",\n);\nexport const useAuth = registerClientReference(\n    function() { throw new Error(\"Attempted to call useAuth() from the server but useAuth is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/shared/src/auth/AuthContext.tsx <module evaluation>\",\n    \"useAuth\",\n);\n"],"names":[],"mappings":";;;;;;AAAA,uEAAuE;AACvE;;AACO,MAAM,eAAe,IAAA,wQAAuB,EAC/C;IAAa,MAAM,IAAI,MAAM;AAAwO,GACrQ,sEACA;AAEG,MAAM,UAAU,IAAA,wQAAuB,EAC1C;IAAa,MAAM,IAAI,MAAM;AAA8N,GAC3P,sEACA","ignoreList":[0]}},
    {"offset": {"line": 167, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/AuthContext.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const AuthProvider = registerClientReference(\n    function() { throw new Error(\"Attempted to call AuthProvider() from the server but AuthProvider is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/shared/src/auth/AuthContext.tsx\",\n    \"AuthProvider\",\n);\nexport const useAuth = registerClientReference(\n    function() { throw new Error(\"Attempted to call useAuth() from the server but useAuth is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/apps/shared/src/auth/AuthContext.tsx\",\n    \"useAuth\",\n);\n"],"names":[],"mappings":";;;;;;AAAA,uEAAuE;AACvE;;AACO,MAAM,eAAe,IAAA,wQAAuB,EAC/C;IAAa,MAAM,IAAI,MAAM;AAAwO,GACrQ,kDACA;AAEG,MAAM,UAAU,IAAA,wQAAuB,EAC1C;IAAa,MAAM,IAAI,MAAM;AAA8N,GAC3P,kDACA","ignoreList":[0]}},
    {"offset": {"line": 186, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":""}},
    {"offset": {"line": 194, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/index.ts"],"sourcesContent":["export type { User, Session, AppRole, UserMetadata } from \"./types\";\r\nexport { createSupabaseClient, mapSupabaseUserToUser } from \"./client\";\r\nexport { getCurrentUser, getRole, getWorkspaceId, isRoleAllowed } from \"./user\";\r\nexport {\r\n  SUPERADMIN_APP_ROLES,\r\n  WORKSPACE_APP_ROLES,\r\n  canAccessApp,\r\n  getAllowedRolesForApp,\r\n} from \"./access\";\r\nexport type { AppName } from \"./access\";\r\nexport { getSession, signOut } from \"./session\";\r\nexport { performLogout } from \"./logout\";\r\nexport { AuthProvider, useAuth } from \"./AuthContext\";\r\nexport type { AuthProviderProps, AuthContextValue } from \"./AuthContext\";\r\n"],"names":[],"mappings":";AACA;AACA;AACA;AAOA;AACA;AACA"}},
    {"offset": {"line": 211, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/superadmin/src/lib/supabase-server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\r\nimport { cookies } from \"next/headers\";\r\n\r\n/**\r\n * Supabase client for server (Server Actions, Server Components).\r\n * Uses cookies for session; use for auth checks only.\r\n */\r\nexport async function createSupabaseServerClient() {\r\n  const cookieStore = await cookies();\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n  const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n  if (!url || !anonKey) throw new Error(\"Missing Supabase env for server client\");\r\n  return createServerClient(url, anonKey, {\r\n    cookies: {\r\n      getAll() {\r\n        return cookieStore.getAll();\r\n      },\r\n      setAll(cookiesToSet: { name: string; value: string; options?: object }[]) {\r\n        try {\r\n          cookiesToSet.forEach(({ name, value, options }) =>\r\n            cookieStore.set(name, value, options)\r\n          );\r\n        } catch {\r\n          // Ignore if called from Server Component read context\r\n        }\r\n      },\r\n    },\r\n  });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAMO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,0IAAO;IACjC,MAAM;IACN,MAAM;IACN;;IACA,OAAO,IAAA,+LAAkB,EAAC,KAAK,SAAS;QACtC,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAiE;gBACtE,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;gBAEjC,EAAE,OAAM;gBACN,sDAAsD;gBACxD;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 245, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/superadmin/src/lib/supabase-admin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\r\n\r\n/**\r\n * Supabase client with service role – use only in Server Actions/API routes.\r\n * Bypasses RLS; can create users via Auth Admin API.\r\n * Never expose this client or the service role key to the client.\r\n */\r\nexport function createSupabaseAdminClient() {\r\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n  const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\r\n  if (!url || !serviceRoleKey) {\r\n    throw new Error(\"Missing NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY\");\r\n  }\r\n  return createClient(url, serviceRoleKey, {\r\n    auth: {\r\n      autoRefreshToken: false,\r\n      persistSession: false,\r\n    },\r\n  });\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,SAAS;IACd,MAAM;IACN,MAAM,iBAAiB,QAAQ,GAAG,CAAC,yBAAyB;IAC5D,IAAI,CAAC,OAAO,CAAC,gBAAgB;QAC3B,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,IAAA,8LAAY,EAAC,KAAK,gBAAgB;QACvC,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 346, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/superadmin/src/lib/email.ts"],"sourcesContent":["import nodemailer from \"nodemailer\";\r\nimport type { Transporter } from \"nodemailer\";\r\n\r\nlet transporter: Transporter | null = null;\r\n\r\nfunction getTransporter(): Transporter | null {\r\n  if (transporter) return transporter;\r\n  const host = process.env.SMTP_HOST;\r\n  const port = process.env.SMTP_PORT;\r\n  const user = process.env.SMTP_USER;\r\n  const pass = process.env.SMTP_PASS;\r\n  if (!host || !user || !pass) return null;\r\n  transporter = nodemailer.createTransport({\r\n    host,\r\n    port: port ? parseInt(port, 10) : 587,\r\n    secure: process.env.SMTP_SECURE === \"true\",\r\n    auth: { user, pass },\r\n  });\r\n  return transporter;\r\n}\r\n\r\nconst DEFAULT_FROM =\r\n  process.env.MAIL_FROM ?? process.env.SMTP_USER ?? \"noreply@getsettime.com\";\r\n\r\n/**\r\n * Send \"New workspace created\" email to the workspace admin.\r\n * No-op if SMTP is not configured; does not throw.\r\n */\r\nexport async function sendWorkspaceCreatedEmail(\r\n  to: string,\r\n  workspaceName: string\r\n): Promise<void> {\r\n  const trans = getTransporter();\r\n  if (!trans) return;\r\n  const subject = `Your workspace \"${workspaceName}\" is ready`;\r\n  const text = `Your new workspace \"${workspaceName}\" has been created. You can now log in to the workspace app with the credentials you received.`;\r\n  const html = `\r\n    <p>Your new workspace <strong>${escapeHtml(workspaceName)}</strong> has been created.</p>\r\n    <p>You can now log in to the workspace app with the credentials you used during setup.</p>\r\n    <p>If you have any questions, please contact your administrator.</p>\r\n  `.trim();\r\n  try {\r\n    await trans.sendMail({\r\n      from: DEFAULT_FROM,\r\n      to,\r\n      subject,\r\n      text,\r\n      html,\r\n    });\r\n  } catch (err) {\r\n    console.error(\"[email] sendWorkspaceCreatedEmail failed:\", err);\r\n  }\r\n}\r\n\r\n/**\r\n * Send \"Workspace disabled\" email to the workspace admin.\r\n * No-op if SMTP is not configured; does not throw.\r\n */\r\nexport async function sendWorkspaceDisabledEmail(\r\n  to: string,\r\n  workspaceName: string\r\n): Promise<void> {\r\n  const trans = getTransporter();\r\n  if (!trans) return;\r\n  const subject = `Your workspace \"${workspaceName}\" has been disabled`;\r\n  const text = `Your workspace \"${workspaceName}\" has been disabled by an administrator. You will not be able to log in to the workspace app until it is enabled again. Please contact your administrator if you have questions.`;\r\n  const html = `\r\n    <p>Your workspace <strong>${escapeHtml(workspaceName)}</strong> has been disabled by an administrator.</p>\r\n    <p>You will not be able to log in to the workspace app until it is enabled again.</p>\r\n    <p>Please contact your administrator if you have questions.</p>\r\n  `.trim();\r\n  try {\r\n    await trans.sendMail({\r\n      from: DEFAULT_FROM,\r\n      to,\r\n      subject,\r\n      text,\r\n      html,\r\n    });\r\n  } catch (err) {\r\n    console.error(\"[email] sendWorkspaceDisabledEmail failed:\", err);\r\n  }\r\n}\r\n\r\n/**\r\n * Send \"Workspace enabled\" email to the workspace admin.\r\n * No-op if SMTP is not configured; does not throw.\r\n */\r\nexport async function sendWorkspaceEnabledEmail(\r\n  to: string,\r\n  workspaceName: string\r\n): Promise<void> {\r\n  const trans = getTransporter();\r\n  if (!trans) return;\r\n  const subject = `Your workspace \"${workspaceName}\" has been enabled`;\r\n  const text = `Your workspace \"${workspaceName}\" has been enabled. You can now log in to the workspace app again.`;\r\n  const html = `\r\n    <p>Your workspace <strong>${escapeHtml(workspaceName)}</strong> has been enabled.</p>\r\n    <p>You can now log in to the workspace app again.</p>\r\n  `.trim();\r\n  try {\r\n    await trans.sendMail({\r\n      from: DEFAULT_FROM,\r\n      to,\r\n      subject,\r\n      text,\r\n      html,\r\n    });\r\n  } catch (err) {\r\n    console.error(\"[email] sendWorkspaceEnabledEmail failed:\", err);\r\n  }\r\n}\r\n\r\nfunction escapeHtml(s: string): string {\r\n  return s\r\n    .replace(/&/g, \"&amp;\")\r\n    .replace(/</g, \"&lt;\")\r\n    .replace(/>/g, \"&gt;\")\r\n    .replace(/\"/g, \"&quot;\");\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAGA,IAAI,cAAkC;AAEtC,SAAS;IACP,IAAI,aAAa,OAAO;IACxB,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS;IAClC,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS;IAClC,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS;IAClC,MAAM,OAAO,QAAQ,GAAG,CAAC,SAAS;IAClC,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,MAAM,OAAO;IACpC,cAAc,0JAAU,CAAC,eAAe,CAAC;QACvC;QACA,MAAM,OAAO,SAAS,MAAM,MAAM;QAClC,QAAQ,QAAQ,GAAG,CAAC,WAAW,KAAK;QACpC,MAAM;YAAE;YAAM;QAAK;IACrB;IACA,OAAO;AACT;AAEA,MAAM,eACJ,QAAQ,GAAG,CAAC,SAAS,IAAI,QAAQ,GAAG,CAAC,SAAS,IAAI;AAM7C,eAAe,0BACpB,EAAU,EACV,aAAqB;IAErB,MAAM,QAAQ;IACd,IAAI,CAAC,OAAO;IACZ,MAAM,UAAU,CAAC,gBAAgB,EAAE,cAAc,UAAU,CAAC;IAC5D,MAAM,OAAO,CAAC,oBAAoB,EAAE,cAAc,8FAA8F,CAAC;IACjJ,MAAM,OAAO,CAAC;kCACkB,EAAE,WAAW,eAAe;;;EAG5D,CAAC,CAAC,IAAI;IACN,IAAI;QACF,MAAM,MAAM,QAAQ,CAAC;YACnB,MAAM;YACN;YACA;YACA;YACA;QACF;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,6CAA6C;IAC7D;AACF;AAMO,eAAe,2BACpB,EAAU,EACV,aAAqB;IAErB,MAAM,QAAQ;IACd,IAAI,CAAC,OAAO;IACZ,MAAM,UAAU,CAAC,gBAAgB,EAAE,cAAc,mBAAmB,CAAC;IACrE,MAAM,OAAO,CAAC,gBAAgB,EAAE,cAAc,gLAAgL,CAAC;IAC/N,MAAM,OAAO,CAAC;8BACc,EAAE,WAAW,eAAe;;;EAGxD,CAAC,CAAC,IAAI;IACN,IAAI;QACF,MAAM,MAAM,QAAQ,CAAC;YACnB,MAAM;YACN;YACA;YACA;YACA;QACF;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,8CAA8C;IAC9D;AACF;AAMO,eAAe,0BACpB,EAAU,EACV,aAAqB;IAErB,MAAM,QAAQ;IACd,IAAI,CAAC,OAAO;IACZ,MAAM,UAAU,CAAC,gBAAgB,EAAE,cAAc,kBAAkB,CAAC;IACpE,MAAM,OAAO,CAAC,gBAAgB,EAAE,cAAc,kEAAkE,CAAC;IACjH,MAAM,OAAO,CAAC;8BACc,EAAE,WAAW,eAAe;;EAExD,CAAC,CAAC,IAAI;IACN,IAAI;QACF,MAAM,MAAM,QAAQ,CAAC;YACnB,MAAM;YACN;YACA;YACA;YACA;QACF;IACF,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,6CAA6C;IAC7D;AACF;AAEA,SAAS,WAAW,CAAS;IAC3B,OAAO,EACJ,OAAO,CAAC,MAAM,SACd,OAAO,CAAC,MAAM,QACd,OAAO,CAAC,MAAM,QACd,OAAO,CAAC,MAAM;AACnB"}},
    {"offset": {"line": 448, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/superadmin/src/app/actions/workspaces.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { getCurrentUser, getRole } from \"@crm/shared/auth\";\r\nimport { createSupabaseServerClient } from \"@/lib/supabase-server\";\r\nimport { createSupabaseAdminClient } from \"@/lib/supabase-admin\";\r\nimport {\r\n  sendWorkspaceCreatedEmail,\r\n  sendWorkspaceDisabledEmail,\r\n  sendWorkspaceEnabledEmail,\r\n} from \"@/lib/email\";\r\nimport type { Workspace } from \"@/lib/types\";\r\n\r\nconst SUPERADMIN_ONLY = \"Only superadmin can perform this action.\";\r\n\r\nasync function requireSuperadmin() {\r\n  const client = await createSupabaseServerClient();\r\n  const user = await getCurrentUser(client);\r\n  if (!user) throw new Error(\"Unauthorized\");\r\n  if (getRole(user) !== \"superadmin\") throw new Error(SUPERADMIN_ONLY);\r\n  return user;\r\n}\r\n\r\n/** Dashboard counts (superadmin only): total workspaces and total leads. */\r\nexport async function getDashboardCounts(): Promise<{\r\n  workspacesCount: number;\r\n  leadsCount: number;\r\n}> {\r\n  await requireSuperadmin();\r\n  const admin = createSupabaseAdminClient();\r\n  const [workspacesRes, leadsRes] = await Promise.all([\r\n    admin.from(\"workspaces\").select(\"*\", { count: \"exact\", head: true }),\r\n    admin.from(\"leads\").select(\"*\", { count: \"exact\", head: true }),\r\n  ]);\r\n  return {\r\n    workspacesCount: workspacesRes.count ?? 0,\r\n    leadsCount: leadsRes.count ?? 0,\r\n  };\r\n}\r\n\r\n/** List all workspaces (superadmin only). Resolves owner email from auth. */\r\nexport async function listWorkspaces(): Promise<Workspace[]> {\r\n  await requireSuperadmin();\r\n  const admin = createSupabaseAdminClient();\r\n  const { data, error } = await admin\r\n    .from(\"workspaces\")\r\n    .select(\"id, name, user_id, disabled, created_at\")\r\n    .order(\"created_at\", { ascending: false });\r\n  if (error) throw new Error(error.message);\r\n  const rows = (data ?? []) as Workspace[];\r\n  const withEmailsAndCounts = await Promise.all(\r\n    rows.map(async (w) => {\r\n      let owner_email: string | null = null;\r\n      if (w.user_id?.trim()) {\r\n        const { data: userData } = await admin.auth.admin.getUserById(w.user_id);\r\n        owner_email = userData?.user?.email ?? null;\r\n      }\r\n      const { count } = await admin\r\n        .from(\"leads\")\r\n        .select(\"*\", { count: \"exact\", head: true })\r\n        .eq(\"workspace_id\", w.id);\r\n      const leads_count = count ?? 0;\r\n      return { ...w, owner_email, leads_count };\r\n    })\r\n  );\r\n  return withEmailsAndCounts;\r\n}\r\n\r\n/** Create a workspace (superadmin only). Uses current user as initial owner until workspace admin is created. */\r\nexport async function createWorkspace(name: string): Promise<Workspace> {\r\n  const user = await requireSuperadmin();\r\n  const admin = createSupabaseAdminClient();\r\n  const { data, error } = await admin\r\n    .from(\"workspaces\")\r\n    .insert({ name, user_id: user.id })\r\n    .select(\"id, name, user_id, disabled, created_at\")\r\n    .single();\r\n  if (error) throw new Error(error.message);\r\n  return data as Workspace;\r\n}\r\n\r\n/** Create a workspace admin user in Supabase Auth and assign them as workspace owner (superadmin only). */\r\nexport async function createWorkspaceAdminUser(\r\n  workspaceId: number,\r\n  email: string,\r\n  password: string\r\n): Promise<void> {\r\n  await requireSuperadmin();\r\n  const admin = createSupabaseAdminClient();\r\n\r\n  const { data: newUser, error: createError } = await admin.auth.admin.createUser({\r\n    email,\r\n    password,\r\n    email_confirm: true,\r\n    user_metadata: {\r\n      role: \"workspace_admin\",\r\n      workspace_id: workspaceId,\r\n    },\r\n  });\r\n  if (createError) throw new Error(createError.message);\r\n  if (!newUser.user) throw new Error(\"User creation failed\");\r\n\r\n  const { error: updateError } = await admin\r\n    .from(\"workspaces\")\r\n    .update({ user_id: newUser.user.id })\r\n    .eq(\"id\", workspaceId);\r\n  if (updateError) throw new Error(updateError.message);\r\n}\r\n\r\n/** Set workspace disabled flag (superadmin only). Disabled workspace admins cannot log in to the workspace app. Sends email to workspace admin. */\r\nexport async function updateWorkspaceDisabled(\r\n  workspaceId: number,\r\n  disabled: boolean\r\n): Promise<void> {\r\n  await requireSuperadmin();\r\n  const admin = createSupabaseAdminClient();\r\n  const { error } = await admin\r\n    .from(\"workspaces\")\r\n    .update({ disabled })\r\n    .eq(\"id\", workspaceId);\r\n  if (error) throw new Error(error.message);\r\n  const { data: workspace } = await admin\r\n    .from(\"workspaces\")\r\n    .select(\"name, user_id\")\r\n    .eq(\"id\", workspaceId)\r\n    .single();\r\n  if (workspace?.user_id) {\r\n    const { data: userData } = await admin.auth.admin.getUserById(\r\n      workspace.user_id as string\r\n    );\r\n    const ownerEmail = userData?.user?.email;\r\n    if (ownerEmail && workspace.name) {\r\n      if (disabled) {\r\n        await sendWorkspaceDisabledEmail(ownerEmail, workspace.name as string);\r\n      } else {\r\n        await sendWorkspaceEnabledEmail(ownerEmail, workspace.name as string);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/** Notify workspace admin by email when a new workspace is created (superadmin only). No-op if SMTP not configured. */\r\nexport async function notifyWorkspaceCreated(\r\n  workspaceName: string,\r\n  adminEmail: string\r\n): Promise<void> {\r\n  await requireSuperadmin();\r\n  await sendWorkspaceCreatedEmail(adminEmail, workspaceName);\r\n}\r\n\r\n/** Delete a workspace by id (superadmin only). Cascades to leads. */\r\nexport async function deleteWorkspace(workspaceId: number): Promise<void> {\r\n  await requireSuperadmin();\r\n  const admin = createSupabaseAdminClient();\r\n  const { error } = await admin.from(\"workspaces\").delete().eq(\"id\", workspaceId);\r\n  if (error) throw new Error(error.message);\r\n}\r\n\r\nconst WORKSPACE_APP_URL =\r\n  process.env.NEXT_PUBLIC_WORKSPACE_APP_URL ?? \"http://localhost:3002\";\r\n\r\n/** Get magic link to open workspace app as superadmin in the given workspace (superadmin only). */\r\nexport async function getWorkspaceLoginLink(\r\n  workspaceId: number\r\n): Promise<{ url: string }> {\r\n  const user = await requireSuperadmin();\r\n  const admin = createSupabaseAdminClient();\r\n  const redirectTo = `${WORKSPACE_APP_URL.replace(/\\/$/, \"\")}/auth/enter?workspace_id=${workspaceId}`;\r\n  const { data, error } = await admin.auth.admin.generateLink({\r\n    type: \"magiclink\",\r\n    email: user.email,\r\n    options: { redirectTo },\r\n  });\r\n  if (error) throw new Error(error.message);\r\n  const link =\r\n    (data as { properties?: { action_link?: string } })?.properties\r\n      ?.action_link;\r\n  if (!link) throw new Error(\"Failed to generate link\");\r\n  return { url: link };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 632, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/superadmin/.next-internal/server/app/%28dashboard%29/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {listWorkspaces as '00237b55da3a452e30a22afcf3f53247b831693c5f'} from 'ACTIONS_MODULE0'\nexport {getDashboardCounts as '005882ea55dfe9fa8b8447bbe24266854295403d83'} from 'ACTIONS_MODULE0'\nexport {getWorkspaceLoginLink as '405e5901a59a87bb21bf2c8f5fdf985fed164d0435'} from 'ACTIONS_MODULE0'\nexport {deleteWorkspace as '406de05990fa881d7fa093859c728b4aee03943cb6'} from 'ACTIONS_MODULE0'\nexport {createWorkspace as '40724e048fcd24b9503b760acdff1cc42a0653a4b5'} from 'ACTIONS_MODULE0'\nexport {notifyWorkspaceCreated as '60384f9d9c6054fd2a32f2fab819e6c7626135e693'} from 'ACTIONS_MODULE0'\nexport {updateWorkspaceDisabled as '6077087eb31cf8dfd3ee7afa5bf105060ac5ffb5cd'} from 'ACTIONS_MODULE0'\nexport {createWorkspaceAdminUser as '70441733904e3aab3459f6a777955cfb92b70a6575'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}