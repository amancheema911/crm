{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 10, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/client.ts"],"sourcesContent":["import { createClient, type SupabaseClient } from \"@supabase/supabase-js\";\r\nimport type { User as SupabaseUser } from \"@supabase/supabase-js\";\r\nimport type { User, AppRole } from \"./types\";\r\n\r\nconst DEFAULT_ROLE: AppRole = \"customer\";\r\n\r\n/**\r\n * Create a Supabase client for browser use.\r\n * Call from each app with env: createSupabaseClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!)\r\n */\r\nexport function createSupabaseClient(\r\n  url: string,\r\n  anonKey: string\r\n): SupabaseClient {\r\n  return createClient(url, anonKey);\r\n}\r\n\r\n/**\r\n * Map Supabase user + user_metadata to our User type.\r\n */\r\nexport function mapSupabaseUserToUser(supabaseUser: SupabaseUser | null): User | null {\r\n  if (!supabaseUser) return null;\r\n\r\n  const meta = (supabaseUser.user_metadata ?? {}) as {\r\n    role?: AppRole;\r\n    workspace_id?: number;\r\n    full_name?: string;\r\n    name?: string;\r\n  };\r\n  const role = meta.role ?? DEFAULT_ROLE;\r\n  const workspace_id =\r\n    typeof meta.workspace_id === \"number\" ? meta.workspace_id : null;\r\n  const name =\r\n    meta.full_name ?? meta.name ?? supabaseUser.email?.split(\"@\")[0] ?? null;\r\n\r\n  return {\r\n    id: supabaseUser.id,\r\n    email: supabaseUser.email ?? \"\",\r\n    name,\r\n    role,\r\n    workspace_id,\r\n  };\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAIA,MAAM,eAAwB;AAMvB,SAAS,qBACd,GAAW,EACX,OAAe;IAEf,OAAO,IAAA,8LAAY,EAAC,KAAK;AAC3B;AAKO,SAAS,sBAAsB,YAAiC;IACrE,IAAI,CAAC,cAAc,OAAO;IAE1B,MAAM,OAAQ,aAAa,aAAa,IAAI,CAAC;IAM7C,MAAM,OAAO,KAAK,IAAI,IAAI;IAC1B,MAAM,eACJ,OAAO,KAAK,YAAY,KAAK,WAAW,KAAK,YAAY,GAAG;IAC9D,MAAM,OACJ,KAAK,SAAS,IAAI,KAAK,IAAI,IAAI,aAAa,KAAK,EAAE,MAAM,IAAI,CAAC,EAAE,IAAI;IAEtE,OAAO;QACL,IAAI,aAAa,EAAE;QACnB,OAAO,aAAa,KAAK,IAAI;QAC7B;QACA;QACA;IACF;AACF"}},
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/user.ts"],"sourcesContent":["import type { SupabaseClient } from \"@supabase/supabase-js\";\r\nimport type { User, AppRole } from \"./types\";\r\nimport { mapSupabaseUserToUser } from \"./client\";\r\n\r\n/**\r\n * Get the current authenticated user from Supabase.\r\n * Returns our User type with role and workspace_id from user_metadata.\r\n */\r\nexport async function getCurrentUser(\r\n  client: SupabaseClient\r\n): Promise<User | null> {\r\n  const {\r\n    data: { user: supabaseUser },\r\n    error,\r\n  } = await client.auth.getUser();\r\n  if (error || !supabaseUser) return null;\r\n  return mapSupabaseUserToUser(supabaseUser);\r\n}\r\n\r\n/**\r\n * Get the user's role from our User (from auth.users.user_metadata.role).\r\n */\r\nexport function getRole(user: User): AppRole {\r\n  return user.role;\r\n}\r\n\r\n/**\r\n * Get the user's workspace_id from our User (from auth.users.user_metadata.workspace_id).\r\n */\r\nexport function getWorkspaceId(user: User): number | null {\r\n  return user.workspace_id;\r\n}\r\n\r\n/**\r\n * Check if the user's role is in the allowed list (for route guards).\r\n */\r\nexport function isRoleAllowed(\r\n  role: AppRole,\r\n  allowedRoles: readonly AppRole[]\r\n): boolean {\r\n  return allowedRoles.includes(role);\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AAEA;;AAMO,eAAe,eACpB,MAAsB;IAEtB,MAAM,EACJ,MAAM,EAAE,MAAM,YAAY,EAAE,EAC5B,KAAK,EACN,GAAG,MAAM,OAAO,IAAI,CAAC,OAAO;IAC7B,IAAI,SAAS,CAAC,cAAc,OAAO;IACnC,OAAO,IAAA,gKAAqB,EAAC;AAC/B;AAKO,SAAS,QAAQ,IAAU;IAChC,OAAO,KAAK,IAAI;AAClB;AAKO,SAAS,eAAe,IAAU;IACvC,OAAO,KAAK,YAAY;AAC1B;AAKO,SAAS,cACd,IAAa,EACb,YAAgC;IAEhC,OAAO,aAAa,QAAQ,CAAC;AAC/B"}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/access.ts"],"sourcesContent":["import type { AppRole } from \"./types\";\r\nimport { isRoleAllowed } from \"./user\";\r\n\r\n/**\r\n * Allowed roles per app â€“ single source of truth for final access validation.\r\n * - Superadmin cannot access workspace app.\r\n * - Workspace admin cannot access superadmin app.\r\n * - Customer can access workspace app only.\r\n * - Invalid users are redirected to login (enforced by proxy + login page).\r\n */\r\nexport const SUPERADMIN_APP_ROLES: readonly AppRole[] = [\"superadmin\"];\r\nexport const WORKSPACE_APP_ROLES: readonly AppRole[] = [\r\n  \"superadmin\",\r\n  \"workspace_admin\",\r\n  \"customer\",\r\n];\r\n\r\nexport type AppName = \"superadmin\" | \"workspace\";\r\n\r\nconst APP_ROLES: Record<AppName, readonly AppRole[]> = {\r\n  superadmin: SUPERADMIN_APP_ROLES,\r\n  workspace: WORKSPACE_APP_ROLES,\r\n};\r\n\r\n/**\r\n * Final access validation: can this role access this app?\r\n * Use in proxy (route guard) and login (after sign-in).\r\n */\r\nexport function canAccessApp(role: AppRole, app: AppName): boolean {\r\n  return isRoleAllowed(role, APP_ROLES[app]);\r\n}\r\n\r\n/**\r\n * Get allowed roles for an app (for error messages / UI).\r\n */\r\nexport function getAllowedRolesForApp(app: AppName): readonly AppRole[] {\r\n  return APP_ROLES[app];\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;AACA;;AASO,MAAM,uBAA2C;IAAC;CAAa;AAC/D,MAAM,sBAA0C;IACrD;IACA;IACA;CACD;AAID,MAAM,YAAiD;IACrD,YAAY;IACZ,WAAW;AACb;AAMO,SAAS,aAAa,IAAa,EAAE,GAAY;IACtD,OAAO,IAAA,sJAAa,EAAC,MAAM,SAAS,CAAC,IAAI;AAC3C;AAKO,SAAS,sBAAsB,GAAY;IAChD,OAAO,SAAS,CAAC,IAAI;AACvB"}},
    {"offset": {"line": 104, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/session.ts"],"sourcesContent":["import type { SupabaseClient } from \"@supabase/supabase-js\";\r\nimport type { Session } from \"./types\";\r\nimport { getCurrentUser } from \"./user\";\r\n\r\n/**\r\n * Get the current session (user + expiry) from Supabase.\r\n * Use getCurrentUser(client) for just the user.\r\n */\r\nexport async function getSession(\r\n  client: SupabaseClient\r\n): Promise<Session | null> {\r\n  const user = await getCurrentUser(client);\r\n  if (!user) return null;\r\n\r\n  const {\r\n    data: { session: supabaseSession },\r\n  } = await client.auth.getSession();\r\n  const expiresAt = supabaseSession?.expires_at\r\n    ? supabaseSession.expires_at * 1000\r\n    : 0;\r\n\r\n  return {\r\n    user,\r\n    expiresAt,\r\n  };\r\n}\r\n\r\n/**\r\n * Sign out the current user via Supabase.\r\n */\r\nexport async function signOut(client: SupabaseClient): Promise<void> {\r\n  await client.auth.signOut();\r\n}\r\n"],"names":[],"mappings":";;;;;;AAEA;;AAMO,eAAe,WACpB,MAAsB;IAEtB,MAAM,OAAO,MAAM,IAAA,uJAAc,EAAC;IAClC,IAAI,CAAC,MAAM,OAAO;IAElB,MAAM,EACJ,MAAM,EAAE,SAAS,eAAe,EAAE,EACnC,GAAG,MAAM,OAAO,IAAI,CAAC,UAAU;IAChC,MAAM,YAAY,iBAAiB,aAC/B,gBAAgB,UAAU,GAAG,OAC7B;IAEJ,OAAO;QACL;QACA;IACF;AACF;AAKO,eAAe,QAAQ,MAAsB;IAClD,MAAM,OAAO,IAAI,CAAC,OAAO;AAC3B"}},
    {"offset": {"line": 129, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/logout.ts"],"sourcesContent":["import type { SupabaseClient } from \"@supabase/supabase-js\";\r\n\r\n/** Keys that may hold auth/session data in storage (clear on logout). */\r\nconst AUTH_STORAGE_KEYS = [\r\n  \"sb-\",\r\n  // Supabase uses sb-<project-ref>-auth-token; prefix covers all\r\n] as const;\r\n\r\n/**\r\n * Clear any cached auth-related data from localStorage/sessionStorage.\r\n * Supabase signOut() clears its own keys; this clears any app-specific or residual keys.\r\n */\r\nfunction clearAuthStorage(): void {\r\n  if (typeof window === \"undefined\") return;\r\n  try {\r\n    const keysToRemove: string[] = [];\r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (key && AUTH_STORAGE_KEYS.some((prefix) => key.startsWith(prefix))) {\r\n        keysToRemove.push(key);\r\n      }\r\n    }\r\n    keysToRemove.forEach((key) => localStorage.removeItem(key));\r\n    const sessionKeysToRemove: string[] = [];\r\n    for (let i = 0; i < sessionStorage.length; i++) {\r\n      const key = sessionStorage.key(i);\r\n      if (key && AUTH_STORAGE_KEYS.some((prefix) => key.startsWith(prefix))) {\r\n        sessionKeysToRemove.push(key);\r\n      }\r\n    }\r\n    sessionKeysToRemove.forEach((key) => sessionStorage.removeItem(key));\r\n  } catch {\r\n    // Ignore storage errors (e.g. private mode)\r\n  }\r\n}\r\n\r\n/**\r\n * Shared logout handler: sign out from Supabase and clear local auth/cached data.\r\n * Use this in both Superadmin and Workspace apps. After calling, clear React auth state\r\n * (e.g. AuthContext setUser(null)) and redirect to the app's login page.\r\n */\r\nexport async function performLogout(client: SupabaseClient | null): Promise<void> {\r\n  if (client) {\r\n    await client.auth.signOut();\r\n  }\r\n  clearAuthStorage();\r\n}\r\n"],"names":[],"mappings":";;;;AAEA,uEAAuE,GACvE,MAAM,oBAAoB;IACxB;CAED;AAED;;;CAGC,GACD,SAAS;IACP,wCAAmC;;;AAqBrC;AAOO,eAAe,cAAc,MAA6B;IAC/D,IAAI,QAAQ;QACV,MAAM,OAAO,IAAI,CAAC,OAAO;IAC3B;IACA;AACF"}},
    {"offset": {"line": 154, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/AuthContext.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport {\r\n  createContext,\r\n  useContext,\r\n  useMemo,\r\n  useCallback,\r\n  useState,\r\n  useEffect,\r\n  type ReactNode,\r\n} from \"react\";\r\nimport type { SupabaseClient } from \"@supabase/supabase-js\";\r\nimport type { User, AppRole } from \"./types\";\r\nimport { getCurrentUser } from \"./user\";\r\nimport { performLogout } from \"./logout\";\r\n\r\nexport interface AuthProviderProps {\r\n  client: SupabaseClient | null;\r\n  children: ReactNode;\r\n  initialSuperadminWorkspaceId?: number | null;\r\n}\r\n\r\nexport interface AuthContextValue {\r\n  user: User | null;\r\n  role: AppRole | null;\r\n  workspaceId: number | null;\r\n  isLoading: boolean;\r\n  signOut: () => Promise<void>;\r\n  /** Supabase client (same as passed to AuthProvider). Use for data with RLS. */\r\n  client: SupabaseClient | null;\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextValue | null>(null);\r\n\r\nexport function AuthProvider({\r\n  client,\r\n  children,\r\n  initialSuperadminWorkspaceId = null,\r\n}: AuthProviderProps) {\r\n  const [user, setUser] = useState<User | null>(null);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  const refreshUser = useCallback(async () => {\r\n    if (!client) return;\r\n    const u = await getCurrentUser(client);\r\n    setUser(u);\r\n  }, [client]);\r\n\r\n  useEffect(() => {\r\n    if (!client) {\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n    let mounted = true;\r\n\r\n    const init = async () => {\r\n      const u = await getCurrentUser(client);\r\n      if (mounted) setUser(u);\r\n      if (mounted) setIsLoading(false);\r\n    };\r\n    init();\r\n\r\n    const {\r\n      data: { subscription },\r\n    } = client.auth.onAuthStateChange(() => {\r\n      if (mounted) refreshUser();\r\n    });\r\n\r\n    return () => {\r\n      mounted = false;\r\n      subscription.unsubscribe();\r\n    };\r\n  }, [client, refreshUser]);\r\n\r\n  const signOut = useCallback(async () => {\r\n    await performLogout(client);\r\n    setUser(null);\r\n  }, [client]);\r\n\r\n  const value = useMemo<AuthContextValue>(\r\n    () => ({\r\n      user,\r\n      role: user?.role ?? null,\r\n      workspaceId:\r\n        user?.role === \"superadmin\" && initialSuperadminWorkspaceId != null\r\n          ? initialSuperadminWorkspaceId\r\n          : user?.workspace_id ?? null,\r\n      isLoading,\r\n      signOut,\r\n      client,\r\n    }),\r\n    [user, isLoading, signOut, client, initialSuperadminWorkspaceId]\r\n  );\r\n\r\n  return (\r\n    <AuthContext.Provider value={value}>{children}</AuthContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useAuth(): AuthContextValue {\r\n  const ctx = useContext(AuthContext);\r\n  if (!ctx) throw new Error(\"useAuth must be used within AuthProvider\");\r\n  return ctx;\r\n}\r\n"],"names":[],"mappings":";;;;;;;AAEA;AAWA;AACA;AAdA;;;;;AAgCA,MAAM,4BAAc,IAAA,sNAAa,EAA0B;AAEpD,SAAS,aAAa,EAC3B,MAAM,EACN,QAAQ,EACR,+BAA+B,IAAI,EACjB;IAClB,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,iNAAQ,EAAc;IAC9C,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAAC;IAE3C,MAAM,cAAc,IAAA,oNAAW,EAAC;QAC9B,IAAI,CAAC,QAAQ;QACb,MAAM,IAAI,MAAM,IAAA,uJAAc,EAAC;QAC/B,QAAQ;IACV,GAAG;QAAC;KAAO;IAEX,IAAA,kNAAS,EAAC;QACR,IAAI,CAAC,QAAQ;YACX,aAAa;YACb;QACF;QACA,IAAI,UAAU;QAEd,MAAM,OAAO;YACX,MAAM,IAAI,MAAM,IAAA,uJAAc,EAAC;YAC/B,IAAI,SAAS,QAAQ;YACrB,IAAI,SAAS,aAAa;QAC5B;QACA;QAEA,MAAM,EACJ,MAAM,EAAE,YAAY,EAAE,EACvB,GAAG,OAAO,IAAI,CAAC,iBAAiB,CAAC;YAChC,IAAI,SAAS;QACf;QAEA,OAAO;YACL,UAAU;YACV,aAAa,WAAW;QAC1B;IACF,GAAG;QAAC;QAAQ;KAAY;IAExB,MAAM,UAAU,IAAA,oNAAW,EAAC;QAC1B,MAAM,IAAA,wJAAa,EAAC;QACpB,QAAQ;IACV,GAAG;QAAC;KAAO;IAEX,MAAM,QAAQ,IAAA,gNAAO,EACnB,IAAM,CAAC;YACL;YACA,MAAM,MAAM,QAAQ;YACpB,aACE,MAAM,SAAS,gBAAgB,gCAAgC,OAC3D,+BACA,MAAM,gBAAgB;YAC5B;YACA;YACA;QACF,CAAC,GACD;QAAC;QAAM;QAAW;QAAS;QAAQ;KAA6B;IAGlE,qBACE,8OAAC,YAAY,QAAQ;QAAC,OAAO;kBAAQ;;;;;;AAEzC;AAEO,SAAS;IACd,MAAM,MAAM,IAAA,mNAAU,EAAC;IACvB,IAAI,CAAC,KAAK,MAAM,IAAI,MAAM;IAC1B,OAAO;AACT"}},
    {"offset": {"line": 241, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/shared/src/auth/index.ts"],"sourcesContent":["export type { User, Session, AppRole, UserMetadata } from \"./types\";\r\nexport { createSupabaseClient, mapSupabaseUserToUser } from \"./client\";\r\nexport { getCurrentUser, getRole, getWorkspaceId, isRoleAllowed } from \"./user\";\r\nexport {\r\n  SUPERADMIN_APP_ROLES,\r\n  WORKSPACE_APP_ROLES,\r\n  canAccessApp,\r\n  getAllowedRolesForApp,\r\n} from \"./access\";\r\nexport type { AppName } from \"./access\";\r\nexport { getSession, signOut } from \"./session\";\r\nexport { performLogout } from \"./logout\";\r\nexport { AuthProvider, useAuth } from \"./AuthContext\";\r\nexport type { AuthProviderProps, AuthContextValue } from \"./AuthContext\";\r\n"],"names":[],"mappings":";AACA;AACA;AACA;AAOA;AACA;AACA"}},
    {"offset": {"line": 258, "column": 0}, "map": {"version":3,"sources":["file:///C:/wamp64/www/crm-leads/crm/apps/superadmin/src/components/AuthWrapper.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useMemo } from \"react\";\r\nimport { createBrowserClient } from \"@supabase/ssr\";\r\nimport { AuthProvider } from \"@crm/shared/auth\";\r\n\r\nexport function AuthWrapper({ children }: { children: React.ReactNode }) {\r\n  const client = useMemo(() => {\r\n    const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n    const anonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n    if (!url || !anonKey) return null;\r\n    return createBrowserClient(url, anonKey);\r\n  }, []);\r\n\r\n  return <AuthProvider client={client}>{children}</AuthProvider>;\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAAA;AACA;AAAA;AAJA;;;;;AAMO,SAAS,YAAY,EAAE,QAAQ,EAAiC;IACrE,MAAM,SAAS,IAAA,gNAAO,EAAC;QACrB,MAAM;QACN,MAAM;QACN;;QACA,OAAO,IAAA,iMAAmB,EAAC,KAAK;IAClC,GAAG,EAAE;IAEL,qBAAO,8OAAC,6JAAY;QAAC,QAAQ;kBAAS;;;;;;AACxC"}}]
}